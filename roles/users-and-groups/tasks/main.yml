# SPDX-License-Identifier: MIT-0
---
# tasks file for creating-users-and-groups

- name: Create groups
  ansible.builtin.group:
    name: "{{ item }}"
    state: "{{ state_present }}"
  loop: "{{ user_groups }}"
  loop_control:
    label: "{{ item }}"
  register: grp

- name: Show creation status for each group
  ansible.builtin.debug:
    msg: "Group {{ item.item }} {{ 'created' if item.changed else 'already exists' }}"
  loop: "{{ grp.results }}"
  loop_control:
    label: "{{ item.item }}"

- name: Create users with temporary passwords
  ansible.builtin.user:
    name: "{{ item.username }}"
    groups: "{{ item.group }}"
    shell: "{{ item.shell }}"
    create_home: "{{ item.create_home }}"
    password: "{{ 'Temp123' | password_hash('sha512') }}"
    password_expire_max: "{{ password_policy.max_days }}"
    password_expire_min: "{{ password_policy.min_days }}"
    password_expire_warn: "{{ password_policy.warn_days }}"
    password_expire_account_disable: "{{ password_policy.inactive_days }}"
    state: "{{ state_present }}"
  loop: "{{ users }}"
  loop_control:
    label: "{{ item.username }}"

- name: Force password change on first login
  ansible.builtin.command:
    cmd: "chage -d 0 {{ item.username }}"
  loop: "{{ users }}"
  loop_control:
    label: "{{ item.username }}"
  when: item.first_login_change
  changed_when: true

# - name: Configure password aging policy for users
#   ansible.builtin.command:
#     cmd: >
#       chage --maxdays {{ password_policy.max_days }}
#             --mindays {{ password_policy.min_days }}
#             --warndays {{ password_policy.warn_days }}
#             --inactive {{ password_policy.inactive_days }}
#             "{{ item.username }}"
#   loop: "{{ users }}"
#   when: password_policy.first_login_change
#   changed_when: true

# - name: Compute expiry timestamp (now + 90 days)
#   ansible.builtin.set_fact:
#     pw_expires_epoch: "{{ (ansible_date_time.epoch | int + pw_lifetime_days * 86400) }}"

# - name: Create users
#   ansible.builtin.user:
#     name: "{{ item.name }}"
#     groups: "{{ item.groups | default(omit) }}"
#     append: "{{ true if item.groups is defined else omit }}"
#     shell: "{{ item.shell | default(omit) }}"
#     home: "{{ item.home | default('/home/' + item.name) }}"
#     password: "{{ item.password | password_hash('sha512') }}"
#     update_password: on_create
#     expires: "{{ pw_expires_epoch }}"
#     password_expire_max: "{{ pw_lifetime_days }}"
#     password_expire_min: 0
#     state: present
#   loop: "{{ users_in_group_dict }}"
#   loop_control:
#     label: "{{ item.name }}"
#     extended: true
#   register: user_result

# - name: Show user creation status
#   ansible.builtin.debug:
#     msg: "User {{ item.item.name }} {{ 'created' if item.changed else 'already exists' }}"
#   loop: "{{ user_result.results }}"
#   loop_control:
#     label: "{{ item.item.name }}"
